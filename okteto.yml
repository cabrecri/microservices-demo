icon: https://github.com/okteto/microservices-demo/raw/main/vote-icon.png

build:
  result:
    context: result
  vote:
    context: vote
  worker:
    context: .
    dockerfile: worker/Dockerfile
  dev:
    context: .
    dockerfile: worker/Dockerfile
    target: dev

deploy:
  - helm repo add bitnami https://charts.bitnami.com/bitnami
  - helm upgrade --install postgresql bitnami/postgresql -f postgresql/values.yml --version 10.16.2
  - helm upgrade --install kafka bitnami/kafka -f kafka/values.yml --version 14.5.0
  - helm upgrade --install vote vote/chart --set image=${OKTETO_BUILD_VOTE_IMAGE}
  - helm upgrade --install result result/chart --set image=${OKTETO_BUILD_RESULT_IMAGE}
  - helm upgrade --install worker worker/chart --set image=${OKTETO_BUILD_WORKER_IMAGE}
  - [[ ${OKTETO_RUN_TEST} = 'true' ]] && make test

dev:
  vote:
    command: ./mvnw spring-boot:run
    sync:
      - vote:/app

  result:
    command: nodemon server.js
    sync:
      - result:/app

  worker:
    image: ${OKTETO_BUILD_DEV_IMAGE}
    command: bash
    securityContext:
      capabilities:
        add:
        - SYS_PTRACE
    sync:
      - worker:/app
      - go-dependencies/database:/app/database
      - go-dependencies/kafka:/app/kafka
    secrets:
      - README.md:/tmp/README.md
    forward:
      - 2345:2345
